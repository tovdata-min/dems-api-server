<!DOCTYPE html>
<html>
  <head>
    <meta title="dEMS api">

    <!-- Bootstrap 4.5.3 CSS -->
    <link rel="stylesheet" href="/assets/stylesheets/bootstrap.css">
    <!-- Main CSS -->
    <link rel="stylesheet" href="/assets/stylesheets/main.css">
    <style>
      #page-header,
      #page-body {
        position: relative;
        width: 100%;
      }
      #page-header {
        margin-bottom: 2rem;
      }

      .ibox {
        border: 1px solid rgba(125, 146, 139, 0.12);
        border-radius: 6px;
      }
      .ibox > .ibox-header {
        padding: 0.9375rem 1.125rem;
      }
      .ibox > .ibox-body {
        padding: 0.9375rem 1.125rem;
        padding-top: 0;
      }
      .ibox-title {
        margin: 0;
      }

      .api-item {
        border: 1px solid rgba(193, 205, 197, 1);
        border-radius: 6px;
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 0.75rem;
        padding: 0.375rem 0;
      }
      .api-access-state {
        display: flex;
        width: 100%;
      }
      .api-access-state .api-link {
        color: #7D928B;
        cursor: pointer;
        font-weight: 700;
      }
      .api-access-state .form-access-state {
        display: flex;
        user-select: none;
      }
      .form-access-state > .item-state {
        border-left: 1px solid rgba(193, 205, 197, 0.45);
        flex: 0 0 33.333333%;
        font-weight: 600;
        max-width: 33.333333%;
        text-align: center;
      }
      .item-state .zero-value {
        color: #989899;
      }
      .item-state .state-success {
        color: #5F6FFA;
      }
      .item-state .state-failed {
        color: #CE5DDE;
      }
      .api-info {
        border-top: 1px dashed rgba(193, 205, 197, 0.45);
        display: block;
        margin-top: 0.45rem;
        padding: 0.45rem 0 0.25rem 0;
        width: 100%;
      }
      .conn-info {
        display: flex;
        flex-wrap: wrap;
      }
      .conn-info-group {
        margin-bottom: 0.625rem;
      }
      .conn-info-group:last-child {
        margin-bottom: 0;
      }
      .conn-info-group .info-subject {
        color:rgba(93, 121, 112, 0.75);
        display: block;
        font-size: 12px;
        margin-bottom: 1px;
        user-select: none;
      }
      .conn-info-group .info-content {
        display: block;
        font-size: 14px;
        margin-bottom: 0;
      }
      @media (min-width: 576px) {
        .api-access-state > .col-sm-12:first-child {
          padding-bottom: 0.35rem;
        }
        .api-access-state > .col-sm-12:last-child {
          border-top: 1px solid rgba(193, 205, 197, 0.45);
          padding-top: 0.35rem;
        }
      }
      @media (min-width: 992px) {
        .api-access-state > .col-sm-12:first-child {
          padding-bottom: 0
        }
        .api-access-state> .col-sm-12:last-child {
          border-top: none;
          padding-top: 0;
        }
      }
    </style>
  </head>
  <body>
    <section>
      <article id="page-header" class="shadow-sm">
        <nav class="container navbar navbar-light">
          <a class="navbar-brand" href="">dEMS API Server</a>
        </nav>
      </article>
      <article id="page-body">
        <div class="container">
          <div class="ibox shadow-sm">
            <div class="ibox-header d-flex">
              <div class="col-6">
                <h5 class="ibox-title">API List</h5>
              </div>
              <div class="col-6">
                <div class="row">
                  <div class="col-4 text-center">Attempt</div>
                  <div class="col-4 text-center">Success</div>
                  <div class="col-4 text-center">Failed</div>
                </div>
              </div>
            </div>
            <div class="ibox-body">

              <div id="api-list">
              </div>
            </div>
          </div>
        </div>
      </article>
    </section>

    <!-- JQuery 3.5.1 JS -->
    <script src="/assets/javascripts/jquery.min.js"></script>
    <!-- Bootstrap 4.5.3 JS -->
    <script src="/assets/javascripts/bootstrap.min.js"></script>
    <script>
      // Get list
      $.ajax({
        type: "GET",
        url: "/request/list",
        success: function(res) {
          if (res.result) {
            console.log(res.message)
            html = ""
            for (key of Object.keys(res.message)) {
              elem = res.message[key];
              html += `
              <div class="api-item" data-id="${key}">
                <div class="api-access-state">
                  <div class="col-sm-12 col-lg-6">
                    <a class="api-link" data-id="${key}">/request/${key}</a>
                  </div>
                  <div class="col-sm-12 col-lg-6">
                    <div class="row form-access-state">
                      <div class="item-state">
                        <span class="state-attempt">${elem.attempt > 0 ? elem.attempt : '<span class="zero-value">' + elem.attempt + '</span>'}</span>
                      </div>
                      <div class="item-state">
                        <span class="state-success">${elem.success > 0 ? elem.success : '<span class="zero-value">' + elem.success + '</span>'}</span>
                      </div>
                      <div class="item-state">
                        <span class="state-failed">${elem.failed > 0 ? elem.failed : '<span class="zero-value">' + elem.failed + '</span>'}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="api-info" data-load=false style="display:none;">
                  <div class="conn-info">
                    <div class="conn-info-group col-sm-12 col-lg-4" data-id="endpoint">
                      <small class="info-subject">EndPoint</small>
                      <p class="info-content"></p>
                    </div>
                    <div class="conn-info-group col-sm-6 col-lg-4" data-id="database">
                      <small class="info-subject">Database</small>
                      <p class="info-content"></p>
                    </div>
                    <div class="conn-info-group col-sm-6 col-lg-4" data-id="table">
                      <small class="info-subject">Table</small>
                      <p class="info-content"></p>
                    </div>
                    <div class="conn-info-group col-12" data-id="syntax">
                      <small class="info-subject">Query syntax</small>
                      <p class="info-content"></p>
                    </div>
                  </div>
                </div>
              </div>`;
            }
            
            document.getElementById('api-list').innerHTML = html;
          } else {
            alert(res.message[0])
          }
        }
      });

      //
      $(document).on('click', '.api-link', function() {
        const id = $(this).data('id');
        const $formInfo = $(`.api-item[data-id="${id}"] .api-info`);
        // Check active status
        if ($formInfo.hasClass("active")) {
          $formInfo.removeClass("active");
          $formInfo.slideUp();
        } else {
          // Check load data
          if (!$formInfo.data("load")) {
            $.ajax({
              type: "GET",
              url: "/request/info",
              data: `id=${id}`,
              success: function(res) {
                if (res.result) {
                  // Set content
                  for (const key of Object.keys(res.message)) {
                    $formInfo.find(`.conn-info-group[data-id="${key}"] .info-content`).text(res.message[key])
                  }
                  // Set load data status
                  $formInfo.data("load", true)
                  $formInfo.slideDown();
                } else {
                  alert(res.message[0]);
                }
              }
            });
          } else {
            $formInfo.slideDown();
          }
          $formInfo.addClass("active");
        }
      });
    </script>
  </body>
</html>